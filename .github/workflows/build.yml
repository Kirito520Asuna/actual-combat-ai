# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
name: Java Jar To Zip Publish
run-name: "Jar ${{ github.event.inputs.tag_name || github.ref_name || 'v-manual' }} version"

on:
  push:
    branches:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: '输入 Release 标签 (eg: v0.35.1, v0.36.5-alpha.1)'
        required: false
        type: string
        default: 'v-manual'
      skip_tests:
        description: '是否跳过测试 (true/false)'
        required: true
        type: boolean
        default: false
      java_version:
        description: '输入 Java 版本 (如 8, 11, 17)'
        required: true
        default: '8'
      jar_dir_prefix:
        description: 'JAR 文件前缀 (如 micro-service 或留空)'
        default: ''
      draft:
        description: '是否为草稿 Release (true/false)'
        type: boolean
        default: false
      prerelease:
        description: '是否为预发布 Release (true/false)'
        type: boolean
        default: false

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      #releases: write
      actions: read
    steps:
      - name: 1.调试触发信息
        run: |
          echo "Event Name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Tag Name: ${{ github.event.inputs.tag_name || github.ref_name }}"
          echo "Skip Tests: ${{ github.event.inputs.skip_tests || true }}"
          echo "Java Version: ${{ github.event.inputs.java_version || '17' }}"
          echo "Jar Dir Prefix: ${{ github.event.inputs.jar_dir_prefix || 'micro-service' }}"
          echo "Draft: ${{ github.event.inputs.draft || false }}"
          echo "Prerelease: ${{ github.event.inputs.prerelease || false }}"
          echo "Repository: ${{ github.repository }}"
          echo "SHA: ${{ github.sha }}"

      - name: 2.检出代码
        uses: actions/checkout@v4

      - name: 3.设置输入值
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name || github.ref_name }}"
          SKIP_TESTS="${{ github.event.inputs.skip_tests || true }}"
          JAVA_VERSION="${{ github.event.inputs.java_version || '17' }}"
          JAR_DIR_PREFIX="${{ github.event.inputs.jar_dir_prefix || 'micro-service' }}"
          DRAFT="${{ github.event.inputs.draft || false }}"
          PRERELEASE="${{ github.event.inputs.prerelease || false }}"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "SKIP_TESTS=$SKIP_TESTS" >> $GITHUB_ENV
          echo "JAVA_VERSION=$JAVA_VERSION" >> $GITHUB_ENV
          echo "JAR_DIR_PREFIX=$JAR_DIR_PREFIX" >> $GITHUB_ENV
          echo "DRAFT=$DRAFT" >> $GITHUB_ENV
          echo "PRERELEASE=$PRERELEASE" >> $GITHUB_ENV
          echo "设置的输入值: TAG_NAME=$TAG_NAME, SKIP_TESTS=$SKIP_TESTS, JAVA_VERSION=$JAVA_VERSION, JAR_DIR_PREFIX=$JAR_DIR_PREFIX, DRAFT=$DRAFT, PRERELEASE=$PRERELEASE"

      - name: 4.验证版本号
        run: |
          echo "当前版本号: $TAG_NAME"
          if ! [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "❌ 错误：版本格式必须符合语义化版本规范 (例如: 1.2.3, 1.2.3-alpha, 1.2.3+build.123)"
            exit 1
          fi
          echo "版本号验证通过"

      - name: 5.设置 Java 环境 version=${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: 6.缓存 Maven 依赖
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: 7.使用 Maven 构建并生成 JAR
        run: |
          if [ ${{ env.SKIP_TESTS }} ]; then
            echo "跳过测试"
            echo "mvn clean package -B -DskipTests -Dquickly"
            mvn clean package -B -DskipTests -Dquickly
          else
            echo "mvn clean package -B -Dquickly"
            mvn clean package -B -Dquickly
          fi
          echo "Maven 构建完成"

      - name: 8.列出匹配的 JAR 文件
        run: |
          if [ "${{ env.JAR_DIR_PREFIX  }}" = "" ]; then
            echo "匹配的 JAR 文件 (*/target/*.jar):"
            find . -type f -path "*/target/*.jar" || echo "未找到匹配的 JAR 文件"
          else
            echo "匹配的 JAR 文件 (*/${{ env.JAR_DIR_PREFIX  }}/*/target/*.jar):"
            find . -type f -path "*/${{ env.JAR_DIR_PREFIX  }}/*/target/*.jar" || echo "未找到匹配的 JAR 文件"
          fi

      - name: 9.打包所有 JAR 文件成 ZIP
        run: |
          if [ "${{ env.JAR_DIR_PREFIX }}" = "" ]; then
            find . -type f -path "*/target/*.jar" -exec zip -j jars-${{ env.TAG_NAME }}.zip {} +
          else
            find . -type f -path "*/${{ env.JAR_DIR_PREFIX  }}/*/target/*.jar" -exec zip -j jars-${{ env.TAG_NAME }}.zip {} +
          fi
          # -j: 仅打包文件，不保留目录结构
          # +: 尽量将多个文件放入一个 zip 命令，减少调用次数
        shell: bash

      - name: 10.验证 ZIP 文件
        run: |
          ls -la jars-${{ env.TAG_NAME}}.zip
          echo "ZIP 文件内容:"
          unzip -l jars-${{ env.TAG_NAME }}.zip

      - name: 11.解压 ZIP 文件
        run: |
          mkdir -p extracted-jars
          unzip jars-${{ env.TAG_NAME }}.zip -d extracted-jars
          echo "解压后的文件:"
          ls -la extracted-jars

      - name: 12.上传 ZIP 到 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            jars-${{ env.TAG_NAME }}.zip
            extracted-jars/*.jar
          tag_name: ${{ env.TAG_NAME }}
          name: Release ${{ env.TAG_NAME }} ${{ env.DRAFT == true && '(Draft)' || '' }} ${{ env.PRERELEASE == true && '(Pre-release)' || '' }}
          body: |
            **Release 信息**
            - 标签: ${{ env.TAG_NAME }}
            - Java 版本: ${{ env.JAVA_VERSION}}
          #            - 是否跳过测试: ${{ github.event.inputs.skip_tests == 'true' && '是' || '否' }}
          #            - Draft 状态: ${{ github.event.inputs.draft == 'true' && '是' || '否' }}
          #            - Pre-release 状态: ${{ github.event.inputs.prerelease == 'true' && '是' || '否' }}
          draft: ${{ env.DRAFT == true || false }}
          prerelease: ${{ env.PRERELEASE == true || false }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
